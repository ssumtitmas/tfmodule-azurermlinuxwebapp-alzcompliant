# Data Model: ALZ-Compliant Linux Web App Terraform Module

**Phase**: 1 - Design & Contracts  
**Date**: 2025-11-06  
**Feature**: ALZ-Compliant Linux Web App Terraform Module

## Core Entities

### Linux Web App
**Purpose**: Primary Azure App Service resource with Linux runtime and ALZ compliance

**Attributes**:
- `name`: Computed from ALZ naming convention (locals)
- `location`: Azure region for deployment (inherited from resource group)
- `resource_group_name`: Target resource group (required input)
- `service_plan_id`: Reference to App Service Plan (computed or provided)
- `https_only`: Always true (ALZ requirement)
- `client_affinity_enabled`: Configurable (default: false)
- `minimum_tls_version`: Always "1.2" (ALZ requirement)

**Identity Configuration**:
- `system_assigned`: Always enabled (ALZ requirement)
- `user_assigned_identity_ids`: Optional list for additional identities

**Site Configuration**:
- `linux_fx_version`: Runtime stack (configurable)
- `app_command_line`: Optional startup command
- `always_on`: Configurable (default: true for production)
- `use_32_bit_worker`: Configurable (default: false)
- `websockets_enabled`: Configurable (default: false)
- `ftps_state`: Always "FtpsOnly" (ALZ security requirement)

**Validation Rules**:
- `name` must comply with ALZ naming convention
- `minimum_tls_version` cannot be less than "1.2"
- `https_only` must always be true
- At least one identity (system or user-assigned) must be configured

### App Service Plan
**Purpose**: Compute resource for hosting web applications

**Attributes**:
- `id`: Resource identifier (provided externally or computed)
- `name`: Computed from ALZ naming convention when created
- `os_type`: Always "Linux" 
- `sku_name`: Configurable size (default: "B1")
- `location`: Must match web app location
- `resource_group_name`: Must match web app resource group

**Creation Logic**:
- If `app_service_plan_id` provided: Use existing plan
- If `app_service_plan_id` null: Create new plan with specified configuration

**Validation Rules**:
- Existing plan must be Linux-compatible
- Location must match web app deployment location
- Resource group must be accessible

### Managed Identity
**Purpose**: Azure AD identity for secure resource access

**System-Assigned Identity**:
- `principal_id`: Generated by Azure (output)
- `client_id`: Generated by Azure (output) 
- `tenant_id`: Azure tenant identifier (output)

**User-Assigned Identity**:
- `identity_ids`: List of existing identity resource IDs (input)
- Identities must exist before module deployment

### Diagnostic Settings
**Purpose**: Centralized logging configuration for ALZ compliance

**Attributes**:
- `log_analytics_workspace_id`: Target workspace (required)
- `name`: Generated diagnostic setting name
- `target_resource_id`: Web app or slot resource ID

**Log Categories** (all enabled):
- `AppServiceHTTPLogs`: HTTP access logs
- `AppServiceConsoleLogs`: Console output
- `AppServiceAppLogs`: Application logs  
- `AppServiceAuditLogs`: Audit events
- `AppServiceIPSecAuditLogs`: IP security logs
- `AppServicePlatformLogs`: Platform logs

**Metrics**:
- `AllMetrics`: Performance and utilization metrics

### Access Restrictions
**Purpose**: Network security controls for inbound traffic

**Structure**:
```hcl
object({
  name         = string
  priority     = number
  action       = string  # Always "Allow"
  ip_address   = optional(string)
  subnet_id    = optional(string) 
  service_tag  = optional(string)
})
```

**Types**:
1. **IP Address**: Single IP or CIDR range
2. **Subnet**: VNet subnet via service endpoint
3. **Service Tag**: Azure service tags (e.g., "Internet", "AzureCloud")

**Validation Rules**:
- Exactly one of `ip_address`, `subnet_id`, or `service_tag` must be specified
- Priority must be between 100-4096
- No duplicate priorities allowed

### Deployment Slots
**Purpose**: Staging environments for zero-downtime deployments

**Attributes**:
- `name`: Slot identifier (input)
- `configuration`: Mirrors production slot security settings
- `auto_swap_slot_name`: Optional auto-swap configuration
- `https_only`: Inherited from main app (always true)
- `minimum_tls_version`: Inherited from main app (always "1.2")

**Inheritance Rules**:
- Security settings always inherited from production slot
- Access restrictions can be configured independently
- Diagnostic settings applied to each slot

## Entity Relationships

```text
Linux Web App (1) ──── (1) App Service Plan
Linux Web App (1) ──── (0..n) Deployment Slots  
Linux Web App (1) ──── (1) System-Assigned Identity
Linux Web App (1) ──── (0..n) User-Assigned Identities
Linux Web App (1) ──── (1) Diagnostic Settings
Linux Web App (1) ──── (0..n) Access Restrictions
Deployment Slot (1) ──── (1) Diagnostic Settings
Deployment Slot (1) ──── (0..n) Access Restrictions
```

## State Transitions

### Web App Lifecycle
1. **Created**: Initial deployment with secure defaults
2. **Configured**: Access restrictions and slot configuration applied
3. **Running**: Operational state with monitoring enabled
4. **Updated**: Configuration changes applied without downtime
5. **Destroyed**: Clean removal of all resources

### Slot Management
1. **Created**: New slot with production parity configuration
2. **Deployed**: Application code deployed to slot
3. **Tested**: Validation in staging environment
4. **Swapped**: Promoted to production slot
5. **Removed**: Slot deletion after successful deployment

## Validation Matrix

| Entity | Required Fields | Optional Fields | Computed Fields |
|--------|----------------|-----------------|-----------------|
| Web App | `resource_group_name` | `app_service_plan_id`, `site_config` | `name`, `default_hostname` |
| App Service Plan | - | `sku_name`, `zone_balancing_enabled` | `name`, `id` |
| Diagnostic Settings | `log_analytics_workspace_id` | `log_categories`, `metric_categories` | `name` |
| Access Restrictions | `name`, `priority` | `ip_address`, `subnet_id`, `service_tag` | - |
| Deployment Slots | `name` | `auto_swap_slot_name` | `default_hostname` |

This data model ensures ALZ compliance while providing flexibility for different deployment scenarios from basic public access to complex private ASE environments.